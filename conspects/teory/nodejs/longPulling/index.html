<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="../style.css">
</head>
<body>
    <h1>Real Time Client-Server (long-pulling)</h1>
    <p>Клиент отправляет запрос, но сервер ему ничего не возвращает. Запрос просто повисает и ждетответа. В случае если время ожидания закончилось, то мы с клиента просто отправляем запрос заново и опять продолжаем ждать. И ждем до тех пор пока не произойдет како-либо событие. На примере с чатом, это событие может быть отправка сообщения каким-то другим пользователем. Запрос все еще висит, но после того как другой пользователь отправил сообщение, срабатывает какое-то событие и сервер возвращает ответ на клиент. В этом случаем мы сразу же отправляем новый запрос и он точно так же повисает до следующего события. </p>

    <h2>Создание сервера</h2>
    <p><span class="num">1</span> Инициализируем проект</p>
    <span class="code">npm init -y</span>
    <p><span class="num">2</span> Устанавливаем зависимости</p>
    <span class="code">npm i express cors ws nodemon</span>
    <ul>
        <li><b>express</b> - для разворачивания сервера</li>
        <li><b>cors</b> - что бы отправлять запросы с браузера</li>
        <li><b>ws</b> - модуль для работы в web-сокетами</li>
        <li><b>nodemon</b> - для запуска среды разработки</li>
    </ul>
    <p><span class="num">3</span> Далее создаем исполняемый файл, который пропишем в качестве main в package.json. Так же в в scripts укажем команду для запуска исполняемого файла через nodemon</p>
    <img src="./img1.jpg" alt="">
    <p><span class="num">4</span> Прописываем стандартные настройки сервера</p>
    <img src="./img2.jpg" alt="">
    <p><span class="num">5</span> Создаем два дефолтных эндпоинта, get запрос на получение сообщения и post на отправку сообщения</p>
    <img src="./img3.jpg" alt="">
    <p>Для того что бы мы могли, по какому-либо событию возвращать ответ на клиент, нам понадобится способ управления событиями в Node.JS - <b>events</b> </p>
    <img src="./img4.jpg" alt="">
    <p>После импорта создаем event emitter с помощью которого мы можем события регистрировать, подписываться на них и соответственно вызывать. </p>
    <img src="./img5.jpg" alt="">
    <p>Теперь напишем обработку отправки сообщения</p>
    <img src="./img6.jpg" alt="">
    <p>После того как мы приняли сообщение, нам необходимо уведомить всех кто подключен к нам о том, что поступило новое сообщение</p>
    <img src="./img7.jpg" alt="">
    <p>emittor.onse - метод который вызовет событие один раз. Первым аргументом мы передаем название события, в нашем случае это - newMessage, вторым параметром передаем callback который будет выполнен в случае если событие случилось. Callback будет принимать один параметр - сообщение, и это же сообщение мы будем возвращать в JSON всем кто подключен.</p>
    <p>Теперь как же событие будет происходить и как оно будет получать это сообщение. Возвращаемся в метод POST. </p>
    <img src="./img8.jpg" alt="">
    <p>Обращаемся к emiter и вызываем метод emit - который создает событие. Метод принимает первым аргументом название события, а вторым принимает элемент, который будет передан в это событие. т.е. такми образом callback в onse получит наш message </p>
    <p>В результате весь файл будет выглядеть вот так:</p>
    <img src="./img9.jpg" alt="">
    <h2>Клиентская часть</h2>
    <p>Разворачиваем React приложение</p>
</body>
</html>