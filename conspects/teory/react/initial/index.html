<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="../style.css">
</head>
<body>
    <h1>Инициализация приложения</h1>
    <h2>Описание проблемы</h2>
    <p>Рассмотрим схему</p>
    <img src="prim1.jpg" alt="">
    <p>Допустим что мы авторизованы</p>
    <p><b>1</b> этап - мы ввели в URL адрес: /dialogs. Наша система настроена так, что не авторизованный пользователь не должен видеть страницу с сообщениями, так как не понятно чьи он должен сообщения видеть раз это анонимный пользователь. Соответственно система его должна будет перенаправить на страницу с логином. Если он введет свои данные произойдет редирект на страницу профайла, т.е. его главной страницы.</p>
    <p>Итак мы авторизованы, переходим на страницу сообщений и если мы обновим страницу, то мы окажемся на странице с профайлом. Почему так выходит?</p>
    <p>Согласно схеме после того как страница загрузилась после обновления, приложение должно понять, авторизован ли пользователь. <b>2</b> - пунктом приложение делает запрос на сервер (запрос назван условно <strong>me</strong>). <span class="red">Но</span> запрос на сервер это ассинхронное действие. <b>3</b> этапом сервер будет обрабатывать запрос и делать он это будет ассинхронно. Одновременно с этим так как по факту в state не указано что прользователь авторизован <b>3</b> этапом (т.е. одновременно с отправкой запроса на сервер) будет произведен Redirect на страницу с логином. По факту мы авторизованы, просто нам сервер пока этого не сообщил. Пока будет происходить redirect <b>4</b> этапом в redux придут данные с сервера о том что мы авторизованы. И будет перерисовка приложения уже с этими данными, и нас тут же <b>5</b> этапом перенесет из страницы login на страницу профайла.</p>
    <h2>Решение</h2>
    <p>Выход из такой ситуации - это не отрисовывать вообще ничего до тех пор пока не произойдет инициализация. Что такое инициализация? Это набор данных в state которые мы должны прослушивать перед тем как отрисовать приложение. Например можно создать в state значение initialized - это будлевое значение, которое будет содержать значение false пока не произойдет запрос на сервер - me (проверка авторизован ли пользователь или нет.) Только после того как запрос me будет совершен (не важно что он вернет), только после этого initialized поменяется на true и только тогда будет выполнен render</p>
    <h2>Реализация</h2>
    <p><span class="num">1</span> Первое что нужно сделать - это превратить нашу компоненту App.js в классовую компоненту, и методе жизненного цикла <b>componentDidMount</b> мы будем делать запро me на сервер</p>
    <img src="prim2.jpg" alt="">
    <p>Оборачиваем App коннектом что бы пробросить callback которая запускает thunk</p>
    <img src="prim3.jpg" alt="">
    <p><span class="num">2</span> Далее необходимо создать еще один reducer который будет отвечать за участок state который будет в свою очередь говорить нам о состоянии инициализации. </p>
    <img src="prim4.jpg" alt="">
    <p>Здесь же создаем <b>thunk</b> которая должна диспатчить наш action только тогда когда будет выполнен запрос <b>me</b> на сервер</p>
    <img src="prim5.jpg" alt="">
    <p>Почему в данном случае dispatch что то возвращает? потому что если в thunk мы вы полнили команду return перед вызовом запроса на сервер (axios) и в итоге dispatch нам вернул promise</p>
    <img src="prim6.jpg" alt="">
    <p>Т.е. если бы мы написали вот так:</p>
    <img src="prim7.jpg" alt="">
    <p>То dispatch нам бы вернул строку 'success'</p>
    <p>Но что если нам надо дождаться несколько dispatch-ей т.е. выполнения нескольких промисов? тогда наша запись выглядела бы так:</p>
    <img src="prim8.jpg" alt="">
    <p><span class="num">3</span> Импортируем наш thunk в App</p>
    <img src="prim9.jpg" alt="">
    <p>Пробрасываем через пропсы с помощью connect thunk, а так же участок state который будет отвечать за инициализацию</p>
    <img src="prim10.jpg" alt="">
    <p>И конечно же не забываем в Redux указать наш новый reducer иначе участка в state так и не создадут</p>
    <img src="prim11.jpg" alt="">
    <p>Все что нам остается это прописать условие: если в state initialized = false то render крутилку прелоадера иначе будет отрисовываться весь контент страницы</p>
    <img src="prim12.jpg" alt="">
    <p>После этого проблем больше не будет</p>


</body>
</html>