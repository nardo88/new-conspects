<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="../style.css">
</head>
<body>
    <h1>Авторизация/Регистрация с использованием JWT</h1>
    <p><a href="https://github.com/nardo88/next-auth" target="_blank">ссылка</a> на репозиторий</p>
    <h2>Настройка</h2>
    <p>Предполагается что у нас есть атлас mongoDb, и развернут NextJS проект</p>
    <p>Вот так выглядит схема коллекции</p>
    <img src="./img1.jpg" alt="">
    <h2>Используемые библиотеки</h2>
    <ul>
        <li><b>mongoose</b></li>
        <li><b>bcrypt</b> - библиотека для хеширования пароля</li>
        <li><b>jsonwebtoken</b></li>
    </ul>
    <h2>Настройка API</h2>
    <p>Тут как обычно в pages создаем папку api внутри нее помещаем файд auth.js. Путь до брекпоинта будет <strong>http://localhost:3000/api/auth</strong></p>
    <h2>Регистрация</h2>
    <p>Создаем новый брекпоинт signup.js</p>
    <p>Минимальная настройка брекпоинта выглядит так:</p>
    <img src="./img2.jpg" alt="">
    <p>С помощью bcrypt хешируем пароль</p>
    <img src="./img3.jpg" alt="">
    <h2>Авторизация</h2>
    <p>Создаем брекпоинт и называем его как login.js</p>
    <p>Минимальная структура выглядит вот так:</p>
    <img src="./img4.jpg" alt="">
    <p>Проверка наличия пользователя с таким login-ом и проверка пароля выглядит вот так:</p>
    <img src="./img5.jpg" alt="">
    <p>с помошью метода compare мы проверяем соответствие паролей из БД и того какой ввел пользователь.</p>
    <p>Если пользователь найден и пароли совпадают, мы должны вернуть JWT токен. Для этого воспользуемся библиотекой <strong>jsonwebtoken</strong></p>
    <img src="./img6.jpg" alt="">
    <p>{ expiresIn: 60 * 60 } - означает что токент будет жить 1 час</p>
    <p>Полученный JWT токен мы можем прочитать на сайте <a href="https://jwt.io/">jwt.io/</a></p>
    <h2>Валидация JWT</h2>
    <p>Каждый эндпоинт мы можем оборачивать в функцию, которая будет проверять JWT и если он валиден, то вернет брекпоинт. Иначе вернет ошибку. Вот как это выглядит:</p>
    <img src="./img7.jpg" alt="">
    <p>А вот как будет выглядеть брекпоинт который будет обернут в эту функцию</p>
    <img src="./img8.jpg" alt="">
    <h2>Использование Cookie</h2>
    <p>Для работы с cookie устанавливаем пакет</p>
    <span class="code">npm install --save cookie</span>
    <p>Теперь переходим в файл брекпоинта авторизации и импортируем cookie</p>
    <img src="./img9.jpg" alt="">
    <p>Теперь перепишем наш брекпоинт что бы он не возвращал в респонсе токен, а помещал токен а cookie</p>
    <img style="max-width: 800px;" src="./code1.png" alt="">
    <p>Теперь если в постмане отправить запрос по нашему брекпоинту, мы увидим вот такой результат</p>
    <img src="./img10.jpg" alt="">
    <p>Теперь как нам проверять этот токен из cookie? Очень просто. В функции которая проверяет токен, мы просто меняем путь откуда будем этот токен вытаскивать:</p>
    <img src="./img11.jpg" alt="">
    <h2>Как использовать cookie на любой странице</h2>
    <p>После того как мы авторизовались и в cookie появился JWT мы получаем из cookie JWT и добавляем его в заголовке запроса к API</p>
    <img src="./img12.jpg" alt="">

</body>
</html>